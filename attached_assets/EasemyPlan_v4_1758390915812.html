<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ease My Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Vibrant Blue & Orange -->
    <!-- Application Structure Plan: A single-page application that simulates a multi-screen experience using JavaScript to control the visibility of different sections (Planner, Itinerary, Cart). This approach was chosen to guide the user through a logical, step-by-step trip planning process, from initial input to final summary, reducing complexity. A modal is used for the AI chatbot to provide an overlay interaction without losing context of the underlying page. -->
    <!-- Visualization & Content Choices: Report Info: Trip details (destinations, dates, theme, budget), Itinerary items (flights, hotels), Summary. Goal: User input, plan presentation, review. Presentation Method: Interactive forms, styled buttons for themes, a slider for budget, and a card-based UI for itinerary items. Interaction: Users input data, select options, and see the plan dynamically generated. A tabbed interface organizes the multi-day itinerary. Justification: These choices use standard, intuitive web components that are ideal for data entry and scannable content, making the prototype easy to use without requiring complex visualizations like charts. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .theme-pill {
            transition: all 0.2s ease-in-out;
        }
        .theme-pill.active {
            background-color: #007BFF;
            color: white;
            font-weight: 600;
        }
        .chat-bubble {
            max-width: 75%;
        }
        .chat-bubble-user {
            background-color: #007BFF;
            color: white;
            align-self: flex-end;
        }
        .chat-bubble-ai {
            background-color: #E9ECEF;
            color: #343A40;
            align-self: flex-start;
        }
        .footer-icon.active svg {
            color: #007BFF;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg h-screen flex flex-col relative">
        
        <!-- === LOADING OVERLAY === -->
        <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-90 z-50 flex flex-col justify-center items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="mt-4 text-lg font-semibold text-gray-700">Generating your personalized plan...</p>
            <p class="text-sm text-gray-500">This may take a moment.</p>
        </div>

        <!-- === SCREEN 1 & 2: PLANNER === -->
        <main id="screen-planner" class="flex-grow overflow-y-auto p-6">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Ease My Plan</h1>
                <p class="text-gray-500">Your AI-powered travel planner</p>
            </header>

            <div class="space-y-4">
                <div>
                    <label for="from" class="block text-sm font-medium text-gray-700">From</label>
                    <select id="from" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option>Bangalore</option>
                        <option>Goa</option>
                        <option>Rishikesh</option>
                        <option>Udaipur</option>
                        <option>Varanasi</option>
                        <option>Varkala</option>
                    </select>
                </div>
                <div>
                    <label for="to" class="block text-sm font-medium text-gray-700">To</label>
                     <select id="to" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option>Goa</option>
                        <option>Bangalore</option>
                        <option>Rishikesh</option>
                        <option>Udaipur</option>
                        <option>Varanasi</option>
                        <option>Varkala</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div id="filters-section" class="mt-8">
                <div class="themes-section">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">Select Your Vibe</h2>
                    <div id="vibes-loading" class="hidden text-center text-gray-500 py-2">Fetching vibes...</div>
                    <div id="vibes-container" class="flex space-x-3 overflow-x-auto pb-2 -mx-6 px-6">
                    </div>
                </div>

                <div class="budget-section mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-gray-800">What's Your Budget?</h2>
                        <span id="budget-value" class="font-bold text-blue-600 text-lg">$1650</span>
                    </div>
                    <input id="budget-slider" type="range" min="300" max="3000" value="1650" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <button id="create-plan-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg mt-8 shadow-lg transition-transform transform hover:scale-105">
                    Create my plan!
                </button>
            </div>
        </main>

        <!-- === SCREEN 3: ITINERARY === -->
        <main id="screen-itinerary" class="hidden flex-grow overflow-y-auto">
            <header class="bg-white sticky top-0 z-10 p-4 shadow-sm">
                <h1 id="trip-title" class="text-xl font-bold text-gray-800 text-center"></h1>
                <nav id="day-tabs" class="flex justify-center mt-4 border-b">
                </nav>
            </header>
            <div id="itinerary-content" class="p-4 space-y-4">
            </div>
        </main>
        
        <!-- === SCREEN 4: CART === -->
        <main id="screen-cart" class="hidden flex-grow overflow-y-auto p-6">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Your Trip Summary</h1>
            </header>
            <div id="cart-items" class="space-y-3">
            </div>
            <div class="mt-6 pt-4 border-t-2 border-dashed">
                 <div class="flex justify-between items-center text-xl font-bold">
                     <span>Total Trip Cost:</span>
                     <span id="cart-total-cost" class="text-blue-600">$0</span>
                 </div>
            </div>
            <div class="recommendations mt-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Improve Your Trip</h2>
                <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                    <p class="font-semibold text-gray-700">Upgrade to a 5-star hotel in a better location for just $100 more.</p>
                    <button class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg">Add to Trip</button>
                </div>
            </div>
             <button class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg mt-8 shadow-lg">
                Proceed to Checkout
            </button>
        </main>
        
        <!-- === FLOATING AI CHAT BUTTON === -->
        <button id="fab-chat" class="hidden fixed bottom-20 right-5 bg-blue-500 text-white rounded-full p-4 shadow-xl hover:bg-blue-600 focus:outline-none z-30">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 22 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        </button>

        <!-- === FOOTER NAVIGATION === -->
        <footer class="bg-white border-t sticky bottom-0">
            <nav class="flex justify-around py-2">
                <button class="footer-icon active" data-screen="planner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    <span class="text-xs">Home</span>
                </button>
                <button class="footer-icon" data-screen="itinerary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <span class="text-xs">Itinerary</span>
                </button>
                <button class="footer-icon" data-screen="cart">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span class="text-xs">Cart</span>
                </button>
                 <button class="footer-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    <span class="text-xs">Profile</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- === SCREEN 5: AI CHATBOT MODAL === -->
    <div id="chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-2xl shadow-lg h-[80%] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Planner AI</h2>
                <button id="close-chat-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </header>
            <div id="chat-window" class="flex-grow p-4 overflow-y-auto flex flex-col space-y-4">
            </div>
            <footer class="p-4 border-t bg-white">
                <div class="flex items-center space-x-2">
                    <input id="chat-input" type="text" placeholder="Type or talk to make changes..." class="flex-grow px-3 py-2 bg-gray-100 border border-gray-300 rounded-full focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <button id="chat-send-btn" class="bg-blue-500 text-white rounded-full p-3 shadow-md hover:bg-blue-600 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${process.env.GEMINI_API_KEY}`;

            const appState = {
                currentScreen: 'planner',
                tripPlan: null,
                selectedDay: 1,
                budget: 1650,
            };
            
            const screens = {
                planner: document.getElementById('screen-planner'),
                itinerary: document.getElementById('screen-itinerary'),
                cart: document.getElementById('screen-cart'),
            };

            const chatModal = document.getElementById('chat-modal');
            const loadingOverlay = document.getElementById('loading-overlay');

            function showScreen(screenId) {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenId]) {
                    screens[screenId].classList.remove('hidden');
                    appState.currentScreen = screenId;

                    document.querySelectorAll('.footer-icon').forEach(icon => {
                        icon.classList.remove('active');
                        if (icon.dataset.screen === screenId) {
                            icon.classList.add('active');
                        }
                    });
                    
                    const fab = document.getElementById('fab-chat');
                    if (screenId === 'itinerary' || screenId === 'cart') {
                        fab.classList.remove('hidden');
                    } else {
                        fab.classList.add('hidden');
                    }
                }
            }
            
            function getEmojiForVibe(vibe) {
                const vibeLower = vibe.toLowerCase();
                if (vibeLower.includes('party')) return '🎉';
                if (vibeLower.includes('beach') || vibeLower.includes('chill') || vibeLower.includes('relax')) return '🏖️';
                if (vibeLower.includes('adventure') || vibeLower.includes('trek') || vibeLower.includes('hike')) return '🧗';
                if (vibeLower.includes('romantic') || vibeLower.includes('honeymoon')) return '❤️';
                if (vibeLower.includes('cultural') || vibeLower.includes('history') || vibeLower.includes('spiritual')) return '🙏';
                if (vibeLower.includes('family')) return '👨‍👩‍👧‍👦';
                if (vibeLower.includes('food') || vibeLower.includes('culinary')) return '🍲';
                return '✈️';
            }

            function setupVibeEventListeners() {
                document.querySelectorAll('.theme-pill').forEach(pill => {
                    pill.addEventListener('click', () => {
                        document.querySelectorAll('.theme-pill').forEach(p => p.classList.remove('active'));
                        pill.classList.add('active');
                    });
                });
            }

            function renderVibes(vibes) {
                const vibesContainer = document.getElementById('vibes-container');
                vibesContainer.innerHTML = '';
                vibes.forEach((vibe, index) => {
                    const pill = document.createElement('button');
                    pill.className = 'theme-pill flex-shrink-0 px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm';
                    if (index === 0) {
                        pill.classList.add('active');
                    }
                    pill.dataset.theme = vibe;
                    pill.innerHTML = `${getEmojiForVibe(vibe)} ${vibe}`;
                    vibesContainer.appendChild(pill);
                });
                setupVibeEventListeners();
            }

            async function generateAndRenderVibes(destination) {
                const vibesLoading = document.getElementById('vibes-loading');
                const vibesContainer = document.getElementById('vibes-container');
                
                vibesLoading.classList.remove('hidden');
                vibesContainer.classList.add('hidden');

                const prompt = `You are a travel expert. For the destination "${destination}", what are the top 5 most relevant travel themes or "vibes"?
                Use Google Search to find popular activities and attractions to determine these themes.
                Return ONLY a valid JSON array of strings, like ["Vibe1", "Vibe2", "Vibe3", "Vibe4", "Vibe5"]. Do not include any other text, explanation, or markdown formatting. For example, for Goa, a good response would be ["Beach & Chill", "Party", "Cultural Exploration", "Adventure Sports", "Family Fun"]. For Rishikesh, it might be ["Spiritual & Yoga", "Adventure Sports", "Trekking", "Relaxing", "Nature Retreat"].`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                };

                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API response not OK');
                    const result = await response.json();
                    let jsonString = result.candidates[0].content.parts[0].text;
                    jsonString = jsonString.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                    const vibes = JSON.parse(jsonString);
                    renderVibes(vibes);
                } catch (error) {
                    console.error("Error fetching vibes:", error);
                    renderVibes(['Party', 'Beach & Chill', 'Adventure', 'Romantic', 'Cultural']); // Fallback
                } finally {
                    vibesLoading.classList.add('hidden');
                    vibesContainer.classList.remove('hidden');
                }
            }

            function initializePlanner() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('start-date').value = today;
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 3);
                document.getElementById('end-date').value = tomorrow.toISOString().split('T')[0];

                document.getElementById('budget-slider').addEventListener('input', (e) => {
                    appState.budget = parseInt(e.target.value);
                    document.getElementById('budget-value').textContent = `$${appState.budget}`;
                });
                
                const toSelect = document.getElementById('to');
                toSelect.addEventListener('change', (e) => {
                    generateAndRenderVibes(e.target.value);
                });

                generateAndRenderVibes(toSelect.value);
            }

            async function generateTripPlan(from, to, startDate, endDate, theme, budget) {
                loadingOverlay.classList.remove('hidden');
                const currentDate = new Date().toLocaleDateString();
                const prompt = `
                    Act as an expert travel agent. Today's date is ${currentDate}.
                    Your primary task is to use the Google Search tool to find real-time, current pricing and availability for flights and hotels. The prices in your response MUST be based on the search results.

                    Create a personalized travel itinerary based on the following details:
                    - Departure City: ${from}
                    - Destination City: ${to}
                    - Start Date: ${startDate}
                    - End Date: ${endDate}
                    - Trip Vibe/Theme: ${theme}
                    - Total Budget: Approximately $${budget} USD

                    **Instructions:**
                    1.  **Search for Flights:** Perform a Google Search for one-way flights from "${from}" to "${to}" on "${startDate}". Extract a real airline, flight number, and its current price in USD.
                    2.  **Search for Hotels:** Perform a Google Search for hotels in "${to}" available from "${startDate}" to "${endDate}" that match the "${theme}" vibe. Find a real hotel and its price per night. Calculate the total price for the duration of the stay.
                    3.  **Search for Activities:** Perform a Google Search for activities in "${to}" that match the "${theme}" vibe. Find 1-2 relevant activities per day and their estimated costs in USD.
                    4.  **Construct the JSON response:** Use the information and prices gathered from your searches to build the itinerary. Ensure the sum of all prices is close to the user's total budget.

                    **Output Format:**
                    Return ONLY a valid JSON object with the exact following structure. Do not include any text, explanation, or markdown formatting before or after the JSON.
                    {
                      "title": "A creative and fitting title for the trip",
                      "days": [
                        {
                          "day_number": 1,
                          "theme": "A theme for this specific day",
                          "ai_summary": "A short, engaging summary of the plan for this day.",
                          "recommendations": [
                            { "type": "flight", "title": "Flight from ${from} to ${to}", "details": "Airline and flight number from search", "provider": "Airline Name from search", "price": <price_from_search> },
                            { "type": "hotel", "title": "Hotel Name from search", "details": "Brief description of the hotel", "provider": "Booking Site found in search", "price": <total_price_from_search> },
                            { "type": "activity", "title": "Activity Name from search", "details": "Description of the activity", "provider": "Tour Operator", "price": <price_from_search> }
                          ]
                        }
                      ]
                    }
                `;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                };

                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    let jsonString = result.candidates[0].content.parts[0].text;
                    
                    jsonString = jsonString.replace(/^```json\s*/, '').replace(/```$/, '').trim();

                    const generatedPlan = JSON.parse(jsonString);

                    let idCounter = 1;
                    generatedPlan.days.forEach(day => {
                        (day.recommendations || []).forEach(rec => {
                            rec.id = idCounter++;
                            rec.included = true;
                            rec.upsell_options = [];
                        });
                    });
                    
                    appState.tripPlan = generatedPlan;
                    appState.selectedDay = 1;
                    renderItinerary();
                    updateCart();
                    showScreen('itinerary');

                } catch (error) {
                    console.error("Error generating trip plan:", error);
                    alert("Could not generate a plan. Please try again."); 
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }

            function renderItinerary() {
                if (!appState.tripPlan) return;
                document.getElementById('trip-title').textContent = appState.tripPlan.title;
                const dayTabsContainer = document.getElementById('day-tabs');
                dayTabsContainer.innerHTML = '';
                
                appState.tripPlan.days.forEach(day => {
                    const tab = document.createElement('button');
                    tab.textContent = `Day ${day.day_number}`;
                    tab.className = `px-4 py-2 text-sm font-medium border-b-2 ${appState.selectedDay === day.day_number ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                    tab.onclick = () => {
                        appState.selectedDay = day.day_number;
                        renderItinerary();
                    };
                    dayTabsContainer.appendChild(tab);
                });

                renderDayContent(appState.selectedDay);
            }
            
            function getIcon(type) {
                switch(type) {
                    case 'flight': return '✈️';
                    case 'hotel': return '🏨';
                    case 'activity': return '🏄';
                    default: return '➡️';
                }
            }

            function renderDayContent(dayNumber) {
                const dayData = appState.tripPlan.days.find(d => d.day_number === dayNumber);
                if (!dayData) return;

                const itineraryContent = document.getElementById('itinerary-content');
                itineraryContent.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800">${dayData.theme}</h2>
                        <p class="text-gray-600 mt-2 text-sm">${dayData.ai_summary}</p>
                    </div>
                    ${(dayData.recommendations || []).map(rec => `
                        <div class="bg-white p-4 rounded-lg shadow-md flex items-start space-x-4 ${!rec.included ? 'opacity-50' : ''}" data-id="${rec.id}">
                            <div class="text-2xl">${getIcon(rec.type)}</div>
                            <div class="flex-grow">
                                <h3 class="font-semibold text-gray-800">${rec.title}</h3>
                                <p class="text-sm text-gray-500">${rec.details}</p>
                                ${rec.provider ? `<p class="text-xs text-gray-400">${rec.provider}</p>` : ''}
                                <p class="font-bold text-gray-700 mt-1">$${rec.price}</p>
                                ${rec.upsell_options && rec.upsell_options.length > 0 ? `<button class="text-blue-500 text-sm mt-1 hover:underline">+ ${rec.upsell_options[0].title} ($${rec.upsell_options[0].additional_cost})</button>` : ''}
                            </div>
                            <input type="checkbox" class="h-5 w-5 rounded text-blue-500 focus:ring-blue-500 recommendation-checkbox" ${rec.included ? 'checked' : ''}>
                        </div>
                    `).join('')}
                `;
                 itineraryContent.querySelectorAll('.recommendation-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const card = e.target.closest('[data-id]');
                        const recId = parseInt(card.dataset.id);
                        
                        appState.tripPlan.days.forEach(day => {
                            const rec = (day.recommendations || []).find(r => r.id === recId);
                            if (rec) {
                                rec.included = e.target.checked;
                                card.classList.toggle('opacity-50', !rec.included);
                            }
                        });
                        updateCart();
                    });
                });
            }

            function updateCart() {
                const cartItemsContainer = document.getElementById('cart-items');
                cartItemsContainer.innerHTML = '';
                let totalCost = 0;
                
                if (appState.tripPlan) {
                    appState.tripPlan.days.forEach(day => {
                        (day.recommendations || []).forEach(rec => {
                            if (rec.included) {
                                totalCost += rec.price;
                                const itemEl = document.createElement('div');
                                itemEl.className = 'bg-white p-3 rounded-lg shadow-sm flex justify-between items-center';
                                itemEl.innerHTML = `
                                    <div>
                                        <p class="font-semibold text-gray-700">${rec.title}</p>
                                        <p class="text-sm text-gray-500">${rec.details}</p>
                                    </div>
                                    <p class="font-bold text-lg text-gray-800">$${rec.price}</p>
                                `;
                                cartItemsContainer.appendChild(itemEl);
                            }
                        });
                    });
                }
                
                document.getElementById('cart-total-cost').textContent = `$${totalCost}`;
            }

            function setupChat() {
                const chatWindow = document.getElementById('chat-window');
                const chatInput = document.getElementById('chat-input');
                
                function addMessage(text, sender) {
                    const bubble = document.createElement('div');
                    bubble.textContent = text;
                    bubble.className = `p-3 rounded-xl chat-bubble ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
                    chatWindow.appendChild(bubble);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
                
                document.getElementById('chat-send-btn').addEventListener('click', () => {
                    const message = chatInput.value.trim();
                    if (!message) return;
                    
                    addMessage(message, 'user');
                    chatInput.value = '';
                    
                    setTimeout(() => {
                        addMessage('Working on it...', 'ai');
                        
                        setTimeout(() => {
                             if (message.toLowerCase().includes('budget')) {
                                const newBudget = parseInt(message.match(/\d+/));
                                if (!isNaN(newBudget)) {
                                    appState.budget = newBudget;
                                    document.getElementById('budget-slider').value = newBudget;
                                    document.getElementById('budget-value').textContent = `$${newBudget}`;
                                    addMessage(`Changed budget to $${newBudget}.`, 'ai');
                                    setTimeout(() => chatModal.classList.add('hidden'), 1000);
                                } else {
                                     addMessage("I couldn't understand the budget amount.", 'ai');
                                }
                            } else {
                                addMessage("Changed.", 'ai');
                                setTimeout(() => chatModal.classList.add('hidden'), 1000);
                            }
                        }, 1500);
                    }, 500);
                });

                document.getElementById('fab-chat').addEventListener('click', () => chatModal.classList.remove('hidden'));
                document.getElementById('close-chat-btn').addEventListener('click', () => chatModal.classList.add('hidden'));
            }

            document.getElementById('create-plan-btn').addEventListener('click', () => {
                const from = document.getElementById('from').value;
                const to = document.getElementById('to').value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const theme = document.querySelector('.theme-pill.active').dataset.theme;
                const budget = appState.budget;

                generateTripPlan(from, to, startDate, endDate, theme, budget);
            });
            
            document.querySelectorAll('.footer-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const screen = icon.dataset.screen;
                    if(screen) showScreen(screen);
                });
            });

            initializePlanner();
            setupChat();
            showScreen('planner');
        });
    </script>
</body>
</html>

